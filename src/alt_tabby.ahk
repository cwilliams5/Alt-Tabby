#Requires AutoHotkey v2.0
#SingleInstance Off  ; Multiple instances allowed for multi-process

;@Ahk2Exe-Base C:\Program Files\AutoHotkey\v2\AutoHotkey64.exe

; Ahk2Exe directives - customize exe metadata (removes AutoHotkey identification)
;@Ahk2Exe-SetDescription Alt-Tabby Window Switcher
;@Ahk2Exe-SetProductName Alt-Tabby
;@Ahk2Exe-SetCopyright Alt-Tabby
;@Ahk2Exe-SetOrigFilename AltTabby.exe
;@Ahk2Exe-SetCompanyName Alt-Tabby

; Version info - generated by compile.bat from VERSION file
; This file may not exist in dev mode (that's OK, GetAppVersion reads VERSION directly)
#Include *i version_info.ahk

; Embed resources - eliminates need for /img folder in compiled exe
; Icon is set via compile.bat /icon flag (becomes main exe icon)
; PNG is embedded as RCDATA resource with ID 10
;@Ahk2Exe-AddResource ..\resources\img\logo.png, 10
;@Ahk2Exe-AddResource ..\resources\img\icon.png, 11
; Animation splash resources (WebP + DLLs)
;@Ahk2Exe-AddResource ..\resources\animation.webp, 15
;@Ahk2Exe-AddResource ..\resources\dll\libsharpyuv-0.dll, 16
;@Ahk2Exe-AddResource ..\resources\dll\libwebp-7.dll, 17
;@Ahk2Exe-AddResource ..\resources\dll\libwebpdemux-2.dll, 18
; WebView2 config editor resources
; NOTE: HTML uses .txt extension because Ahk2Exe silently fails to embed .html files
;@Ahk2Exe-AddResource ..\resources\dll\WebView2Loader.dll, 20
;@Ahk2Exe-AddResource ..\resources\html\config_editor.txt, 25

; ============================================================
; Alt-Tabby - Unified Launcher & Mode Router
; ============================================================
; Usage:
;   alt_tabby.exe             - Launch GUI + Store (default)
;   alt_tabby.exe --store     - Run as WindowStore server
;   alt_tabby.exe --viewer    - Run as Debug Viewer
;   alt_tabby.exe --gui-only  - Run as GUI only (store must be running)
;   alt_tabby.exe --config    - Run Config Editor
;   alt_tabby.exe --blacklist - Run Blacklist Editor
;
; IMPORTANT: Mode flag is set BEFORE includes. Each module checks
; this flag and only initializes if it matches.
; ============================================================

; ============================================================
; MODE FLAG - SET BEFORE ANY INCLUDES!
; ============================================================
global g_AltTabbyMode := "launch"
global g_TestingMode := false  ; Skip wizard and install mismatch dialogs (for automated testing)
global g_SkipMismatchCheck := false  ; Skip mismatch dialog (after one-time elevation from mismatch)
global g_SkipActiveMutex := false  ; Skip active mutex check (user already declined killing other instance)

for _, arg in A_Args {
    switch StrLower(arg) {
        case "--store":
            g_AltTabbyMode := "store"
            A_IconHidden := true  ; Hide tray icon IMMEDIATELY to minimize flicker
        case "--viewer":
            g_AltTabbyMode := "viewer"
            A_IconHidden := true
        case "--gui-only":
            g_AltTabbyMode := "gui"
            A_IconHidden := true
        case "--config":
            g_AltTabbyMode := "config"
            A_IconHidden := true  ; Editors show their own window, no tray icon needed
        case "--blacklist":
            g_AltTabbyMode := "blacklist"
            A_IconHidden := true  ; Editors show their own window, no tray icon needed
        case "--wizard-continue":
            g_AltTabbyMode := "wizard-continue"
            ; Continue wizard after self-elevation (elevated instance)
        case "--enable-admin-task":
            g_AltTabbyMode := "enable-admin-task"
            ; Create admin task after self-elevation (from tray menu toggle)
        case "--apply-update":
            g_AltTabbyMode := "apply-update"
            ; Apply downloaded update after self-elevation
        case "--update-installed":
            g_AltTabbyMode := "update-installed"
            ; Update installed version after self-elevation (from mismatch detection)
        case "--repair-admin-task":
            g_AltTabbyMode := "repair-admin-task"
            ; Repair stale admin task after self-elevation
        case "--disable-admin-task":
            g_AltTabbyMode := "disable-admin-task"
            ; Delete admin task after self-elevation (from "Always run from here")
        case "--install-to-pf":
            g_AltTabbyMode := "install-to-pf"
            ; Install to Program Files after self-elevation (from tray/dashboard)
        case "--testing-mode":
            g_TestingMode := true
            A_IconHidden := true  ; No tray icon during automated testing
            ; Skip wizard and install mismatch dialogs (for automated testing)
        case "--skip-mismatch":
            g_SkipMismatchCheck := true
            g_SkipActiveMutex := true
            ; Skip mismatch dialog and active mutex check (after one-time elevation from mismatch prompt)
    }
}

; Note: Subprocess tray icon hiding is done immediately in arg parsing above
; to minimize flicker (A_IconHidden := true set as soon as mode detected)

; Note: Launcher initialization moved to after includes (needs ConfigLoader_Init)

; ============================================================
; INCLUDES
; ============================================================
; Use #Include <Dir> to set the include base directory before
; including each module, so relative paths resolve correctly.

; Third-party libraries (from src/lib/)
#Include %A_ScriptDir%\lib\
#Include cjson.ahk
#Include icon_alpha.ahk
#Include *i WebView2.ahk
#Include *i ComVar.ahk
#Include *i Promise.ahk

; Shared libraries (from src/shared/)
#Include %A_ScriptDir%\shared\
#Include config_loader.ahk
#Include theme.ahk
#Include theme_msgbox.ahk
#Include gui_antiflash.ahk
#Include ipc_pipe.ahk
#Include blacklist.ahk
#Include setup_utils.ahk
#Include process_utils.ahk
#Include win_utils.ahk
#Include pump_utils.ahk
#Include resource_utils.ahk

; Editor subprocesses (from src/editors/)
#Include %A_ScriptDir%\editors\
#Include config_editor.ahk
#Include config_editor_native.ahk
#Include config_editor_webview.ahk
#Include blacklist_editor.ahk

; Launcher module (from src/launcher/)
#Include %A_ScriptDir%\launcher\
#Include launcher_utils.ahk
#Include launcher_splash.ahk
#Include launcher_shortcuts.ahk
#Include launcher_install.ahk
#Include launcher_wizard.ahk
#Include launcher_about.ahk
#Include launcher_stats.ahk
#Include launcher_tray.ahk
#Include launcher_main.ahk

; Store module (from src/store/)
#Include %A_ScriptDir%\store\
#Include windowstore.ahk
#Include winenum_lite.ahk
#Include mru_lite.ahk
#Include komorebi_lite.ahk
#Include komorebi_sub.ahk
#Include icon_pump.ahk
#Include proc_pump.ahk
#Include winevent_hook.ahk
#Include store_server.ahk

; Viewer module (from src/viewer/)
#Include %A_ScriptDir%\viewer\
#Include viewer.ahk

; GUI module (from src/gui/)
#Include %A_ScriptDir%\gui\
#Include gui_gdip.ahk
#Include gui_win.ahk
#Include gui_overlay.ahk
#Include gui_workspace.ahk
#Include gui_paint.ahk
#Include gui_input.ahk
#Include gui_flight_recorder.ahk
#Include gui_store.ahk
#Include gui_state.ahk
#Include gui_interceptor.ahk
#Include gui_main.ahk

; ============================================================
; CONFIG MODE HANDLER
; ============================================================
; Run config editor and exit when launched with --config
; Supports --force-native flag to skip WebView2 and use AHK GUI
if (g_AltTabbyMode = "config") {
    global ARG_LAUNCHER_HWND, ARG_LAUNCHER_HWND_LEN
    launcherHwnd := 0
    forceNative := false
    for _, arg in A_Args {
        if (SubStr(arg, 1, ARG_LAUNCHER_HWND_LEN) = ARG_LAUNCHER_HWND)
            launcherHwnd := Integer(SubStr(arg, ARG_LAUNCHER_HWND_LEN + 1))
        else if (arg = "--force-native")
            forceNative := true
    }
    ; Theme_Init is called inside ConfigEditor_Run after ConfigLoader_Init
    ConfigEditor_Run(launcherHwnd, forceNative)
    ExitApp()
}

; Run blacklist editor and exit when launched with --blacklist
if (g_AltTabbyMode = "blacklist") {
    ; Initialize config + theme for blacklist editor process
    ConfigLoader_Init()
    Theme_Init()
    BlacklistEditor_Run()
    ExitApp()
}

; ============================================================
; WIZARD-CONTINUE MODE (After Self-Elevation)
; ============================================================
if (g_AltTabbyMode = "wizard-continue") {
    ConfigLoader_Init()
    Theme_Init()
    Launcher_EnsureInstallationId()  ; Must be before WizardContinue (may create admin task)
    wizardResult := WizardContinue()

    if (wizardResult = "installed") {
        ; Installed to different location - new exe was launched, we exit
        ExitApp()
    } else if (wizardResult) {
        ; Wizard completed - launch normally (from same location)

        ; Acquire mutex before running as launcher
        ; Bug fix: Without this, wizard-continue could run alongside another launcher
        if (!Launcher_AcquireMutex()) {
            ThemeMsgBox("Alt-Tabby is already running.", APP_NAME, "Iconi")
            ExitApp()
        }

        Launcher_LogStartup()
        Launcher_StartSubprocesses()
    } else {
        ; No wizard data found - exit
        ThemeMsgBox("Setup could not continue â€” required data was not found.`n`n"
            "Please restart Alt-Tabby to try again.", APP_NAME, "Iconx")
        ExitApp()
    }
}

; ============================================================
; ENABLE-ADMIN-TASK MODE (After Self-Elevation from Tray Menu)
; ============================================================
if (g_AltTabbyMode = "enable-admin-task") {
    ConfigLoader_Init()
    Theme_Init()
    Launcher_EnsureInstallationId()  ; Must be before CreateAdminTask

    exePath := A_ScriptFullPath
    exeDir := ""
    SplitPath(exePath, , &exeDir)

    ; Warn if admin task would point to a temporary location
    if (!WarnIfTempLocation_AdminTask(exePath, exeDir)) {
        AdminToggle_WriteResult("cancelled")
        ExitApp()
    }

    if (CreateAdminTask(exePath)) {
        Setup_SetRunAsAdmin(true)
        Setup_ClearAdminDeclinedMarker()
        RecreateShortcuts()  ; Update to point to schtasks
        AdminToggle_WriteResult("ok")
    } else {
        AdminToggle_WriteResult("failed")
    }

    ExitApp()
}

; ============================================================
; REPAIR-ADMIN-TASK MODE (After Self-Elevation for Stale Task)
; ============================================================
if (g_AltTabbyMode = "repair-admin-task") {
    ConfigLoader_Init()
    Theme_Init()
    Launcher_EnsureInstallationId()  ; Must be before CreateAdminTask

    ; Recreate task with current exe path
    exePath := A_ScriptFullPath
    if (AdminTask_EnsurePointsTo(exePath, cfg.SetupInstallationId, true)) {
        Setup_SetRunAsAdmin(true)
        Setup_ClearAdminDeclinedMarker()

        ; Update SetupExePath to current location (handles renamed exe case)
        Setup_SetExePath(exePath)

        ; Update shortcuts to point to new exe path
        RecreateShortcuts()

        TrayTip("Admin Mode Repaired", "Scheduled task and shortcuts updated.", "Iconi")

        ; Now launch via the repaired task
        exitCode := RunAdminTask(TIMING_TASK_READY_WAIT)

        if (exitCode != 0) {
            ; Task run failed - launch directly instead
            ThemeMsgBox("Admin mode was repaired, but the scheduled task could not start`n"
                "(exit code " exitCode ").`n`nLaunching Alt-Tabby directly instead.", APP_NAME, "Icon!")
            Run('"' exePath '"')
        }
    } else {
        ThemeMsgBox("Could not repair the admin mode scheduled task.`n`n"
            "Possible causes:`n"
            "  - Task Scheduler service is not running`n"
            "  - Insufficient permissions`n`n"
            "Alt-Tabby will launch without admin privileges.", APP_NAME, "Iconx")
        ; Fall back to direct launch
        Run('"' exePath '"')
    }
    ExitApp()
}

; ============================================================
; DISABLE-ADMIN-TASK MODE (After Self-Elevation from "Always run from here")
; ============================================================
if (g_AltTabbyMode = "disable-admin-task") {
    ConfigLoader_Init()
    Theme_Init()

    ; Delete the admin task
    if (AdminTaskExists()) {
        DeleteAdminTask()
        Setup_SetRunAsAdmin(false)
    }
    ; Silently exit - the non-elevated caller will continue
    ExitApp()
}

; ============================================================
; APPLY-UPDATE MODE (After Self-Elevation for Update)
; ============================================================
if (g_AltTabbyMode = "apply-update") {
    ConfigLoader_Init()
    Theme_Init()  ; Required for themed MsgBox dialogs
    ; Apply the downloaded update (we're now elevated)
    if (!Update_ContinueFromElevation()) {
        ThemeMsgBox("The update could not be completed after elevation.`n`n"
            "The previous version should still be intact.`n"
            "Please try updating again from the tray menu.", APP_NAME, "Iconx")
        ; Attempt to relaunch the current exe (rollback should have restored it)
        ; This ensures user doesn't end up with no running instance after failed update
        if (FileExist(A_ScriptFullPath)) {
            try Run('"' A_ScriptFullPath '"')
        }
    }
    ExitApp()
}

; ============================================================
; UPDATE-INSTALLED MODE (After Self-Elevation for Install Mismatch)
; ============================================================
if (g_AltTabbyMode = "update-installed") {
    ConfigLoader_Init()
    Theme_Init()
    global TEMP_INSTALL_UPDATE_STATE

    try {
        state := ReadStateFile(TEMP_INSTALL_UPDATE_STATE)
        sourcePath := state.source
        targetPath := state.target

        ; Validate target is an exe in an expected directory (more secure than name-based,
        ; more permissive for renamed exes that don't contain "tabby" in the name)
        targetName := ""
        targetDir := ""
        SplitPath(targetPath, &targetName, &targetDir)
        if (!RegExMatch(targetName, "i)\.exe$")) {
            ThemeMsgBox("Invalid update target path:`n" targetPath, APP_NAME, "Iconx")
            ExitApp()
        }
        ; Target directory must be: same as source, SetupExePath's dir, or Program Files install dir
        sourceDir := ""
        SplitPath(sourcePath, , &sourceDir)
        setupDir := ""
        if (cfg.HasOwnProp("SetupExePath") && cfg.SetupExePath != "") {
            SplitPath(cfg.SetupExePath, , &setupDir)
        }
        if (!PathsEqual(targetDir, sourceDir)
            && (setupDir = "" || !PathsEqual(targetDir, setupDir))
            && !PathsEqual(targetDir, ALTTABBY_INSTALL_DIR)) {
            ThemeMsgBox("Update target directory is not recognized:`n" targetPath, APP_NAME, "Iconx")
            ExitApp()
        }

        Launcher_DoUpdateInstalled(sourcePath, targetPath)
    } catch as e {
        ThemeMsgBox("Update failed`n`n" e.Message "`n`n"
            "Possible causes:`n"
            "  - Another program is using Alt-Tabby files`n"
            "  - Insufficient disk space or permissions`n`n"
            "The previous version is still intact. Try closing all Alt-Tabby`n"
            "processes and running the update again.", APP_NAME, "Iconx")
    }
    ExitApp()
}

; ============================================================
; INSTALL-TO-PF MODE (After Self-Elevation from Tray/Dashboard)
; ============================================================
if (g_AltTabbyMode = "install-to-pf") {
    ConfigLoader_Init()
    Theme_Init()

    global TEMP_INSTALL_PF_STATE

    try {
        state := ReadStateFile(TEMP_INSTALL_PF_STATE)

        ; Launcher_DoUpdateInstalled handles everything:
        ; DirCreate, blacklist copy, stats merge, config copy, admin task, shortcuts, relaunch
        Launcher_DoUpdateInstalled(state.source, state.target)
    } catch as e {
        ThemeMsgBox("Installation failed`n`n" e.Message "`n`n"
            "Possible causes:`n"
            "  - Insufficient permissions (try Run as Administrator)`n"
            "  - Another program is using the target files`n"
            "  - Insufficient disk space`n`n"
            "The original file has not been modified.", APP_NAME, "Iconx")
    }
    ExitApp()
}

; ============================================================
; LAUNCHER MODE INITIALIZATION
; ============================================================
; Must be after includes so we can use ConfigLoader_Init
if (g_AltTabbyMode = "launch") {
    ; Initialize config first
    ConfigLoader_Init()

    ; Initialize theme (before any GUIs are created)
    Theme_Init()

    ; Run main launcher initialization
    Launcher_Init()
}
